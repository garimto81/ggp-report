# 보고서 자동 스케줄 로직 설계서

## 📋 개요

Slack Report Automation 시스템의 주간/월간 보고서 자동화 로직 구현 문서입니다.

## 🎯 보고서 스케줄 규칙

### 1. 우선순위
1. **월간 보고서** (최우선)
2. **주간 보고서** (차순위)  
3. **일일 보고서** (기본)

### 2. 실행 시간
- 모든 보고서: **한국시간 오전 10시** (UTC 01:00)
- 평일(월-금)에만 실행

### 3. 실행 규칙
- **첫째 월요일**: 월간 보고서만 실행 (일일/주간 생략)
- **나머지 월요일**: 주간 보고서만 실행 (일일 생략)
- **화요일-금요일**: 일일 보고서 실행
- **주말(토-일)**: 보고서 없음

## 🔄 자동 실행 로직

### GitHub Actions Workflow
```yaml
schedule:
  - cron: '0 1 * * 1-5'  # 평일 오전 10시 KST
```

### 보고서 타입 결정 알고리즘
```bash
if [ 월요일 ]; then
  if [ 날짜가 1-7일 사이 ]; then
    # 첫째 월요일 → 월간 보고서
    type=monthly
  else
    # 나머지 월요일 → 주간 보고서
    type=weekly
  fi
elif [ 화-금 ]; then
  # 일일 보고서
  type=daily
else
  # 주말 → 실행 안함
  should_run=false
fi
```

## 📊 보고서별 데이터 수집 기간

### 일일 보고서
- **수집 기간**: 최근 24시간
- **실행일**: 화요일-금요일
- **예시**: 화요일 오전 10시 실행 → 월요일 오전 10시 ~ 화요일 오전 10시 데이터

### 주간 보고서
- **수집 기간**: 지난주 월요일 00:00 ~ 일요일 23:59
- **실행일**: 첫째 월요일을 제외한 월요일
- **예시**: 월요일 실행 → 이전 주 전체 데이터 (7일)

### 월간 보고서
- **수집 기간**: 지난달 1일 00:00 ~ 마지막일 23:59
- **실행일**: 매월 첫째 월요일
- **예시**: 8월 첫째 월요일 실행 → 7월 전체 데이터

## 🗓️ 실행 예시 (2025년 8월)

| 날짜 | 요일 | 보고서 타입 | 비고 |
|------|------|------------|------|
| 8/1 | 금 | 일일 | 7/31 10시 ~ 8/1 10시 |
| 8/2 | 토 | - | 주말 |
| 8/3 | 일 | - | 주말 |
| 8/4 | 월 | **월간** | 첫째 월요일 (7월 전체) |
| 8/5 | 화 | 일일 | 8/4 10시 ~ 8/5 10시 |
| 8/6 | 수 | 일일 | 8/5 10시 ~ 8/6 10시 |
| 8/7 | 목 | 일일 | 8/6 10시 ~ 8/7 10시 |
| 8/8 | 금 | 일일 | 8/7 10시 ~ 8/8 10시 |
| 8/9 | 토 | - | 주말 |
| 8/10 | 일 | - | 주말 |
| 8/11 | 월 | **주간** | 8/4 ~ 8/10 (지난주) |
| ... | ... | ... | ... |

## 🛠️ 구현 세부사항

### 1. GitHub Actions (`reports.yml`)
- 단일 cron 스케줄로 평일 실행
- 실행 시 날짜 확인하여 보고서 타입 동적 결정
- 환경변수로 보고서 타입 전달

### 2. 스케줄러 (`scheduler.ts`)
- 통합 스케줄러로 모든 보고서 관리
- 날짜 기반 조건부 실행
- 명확한 로그 출력

### 3. 보고서 서비스 (`report.service.ts`)
- 정확한 기간 계산 로직
- 주간: 지난주 월-일
- 월간: 지난달 전체

## 📌 주의사항

1. **시간대**: 모든 시간은 한국시간(KST) 기준
2. **중복 방지**: 같은 날 여러 보고서가 실행되지 않도록 우선순위 적용
3. **수동 실행**: GitHub Actions에서 언제든 수동으로 특정 보고서 실행 가능
4. **데이터 정확성**: 보고서별 정확한 기간 데이터만 수집

## 🚀 향후 개선사항

1. 보고서별 개별 워크플로우 분리 고려
2. 공휴일 처리 로직 추가
3. 보고서 실행 이력 저장 및 추적
4. 실패 시 재시도 메커니즘